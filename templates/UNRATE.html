<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labor Market</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
    <style>
        .date-links a {
            margin: 0 5px;
            text-decoration: none;
            background: #f4f4f4;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .date-links a:hover {
            background: #ddd;
        }
    </style>
</head>

<body>
    <div class="body">

        {% for plot_divs, code in zip(plots, ['UNRATE', 'CIVPART', 'EMRATIO']) %}
        <section>
            <h3>{{ code }}</h3>

            <!-- Linked windows for Date Ranges -->
            <div class="date-links">
                <a href="#" onclick="updateGraphForCode('{{ code }}', '1Y')">1 Year</a>
                <a href="#" onclick="updateGraphForCode('{{ code }}', '3Y')">3 Years</a>
                <a href="#" onclick="updateGraphForCode('{{ code }}', '5Y')">5 Years</a>
                <a href="#" onclick="updateGraphForCode('{{ code }}', '10Y')">10 Years</a>
                <a href="#" onclick="updateGraphForCode('{{ code }}', 'ALL')">All</a>
            </div>

            <label for="units-{{ code }}">Transformation:</label>
            <select id="units-{{ code }}" name="units" onchange="updateGraphForCode('{{ code }}')">
                <option value="lin">Levels (No transformation)</option>
                <option value="chg">Change</option>
                <option value="ch1">Change from Year Ago</option>
                <option value="pch">Percent Change</option>
                <option value="pc1">Percent Change from Year Ago</option>
                <option value="pca">Compounded Annual Rate of Change</option>
                <option value="cch">Continuously Compounded Rate of Change</option>
                <option value="cca">Continuously Compounded Annual Rate of Change</option>
                <option value="log">Natural Log</option>
            </select>

            <div class="plot-container" id="plot-container-{{ code }}">
                {{plot_divs|safe}}
            </div>
        </section>
        {% endfor %}

    </div>

    <script>
        function renderPlotlyGraph(data, code) {
            const layout = {
                title: code,
                xaxis: {
                    title: 'Time',
                    linecolor: 'black',
                    linewidth: 1,
                    mirror: true
                },
                yaxis: {
                    title: 'Value',
                    linecolor: 'black',
                    linewidth: 1,
                    mirror: true
                },
                plot_bgcolor: "#F5F5F5",
                paper_bgcolor: "#E5E5E5",
            };

            const trace = {
                x: data.date,
                y: data.value,
                mode: 'lines',
                line: { color: '#1f77b4' }
            };

            Plotly.newPlot(`plot-container-${code}`, [trace], layout);
        }

        function updateGraphForCode(code, windowPeriod) {
            // ... [Your logic remains unchanged for setting dates and fetching data]
            const currentDate = new Date();
            let realtime_end = currentDate.toISOString().split('T')[0]-1;  // Today's date in UTC
            console.log("Realtime End:", realtime_end);
            let startDate = new Date(Date.UTC(currentDate.getUTCFullYear(), currentDate.getUTCMonth(), currentDate.getUTCDate()));
            // Subtracting one day
            const dayInMilliseconds = 24 * 60 * 60 * 1000;  // 24 hours * 60 minutes * 60 seconds * 1000 milliseconds
            let subtractedDate = new Date(currentDate - dayInMilliseconds);
            realtime_end = subtractedDate.toISOString().split('T')[0];
            switch (windowPeriod) {
                case '1Y':
                    startDate.setUTCFullYear(startDate.getUTCFullYear() - 1);
                    break;
                case '3Y':
                    startDate.setUTCFullYear(startDate.getUTCFullYear() - 3);
                    break;
                case '5Y':
                    startDate.setUTCFullYear(startDate.getUTCFullYear() - 5);
                    break;
                case '10Y':
                    startDate.setUTCFullYear(startDate.getUTCFullYear() - 10);
                    break;
                case 'ALL':
                    startDate = null;  // Adjust to your dataset's start date or keep it null
                    break;
            }
            const realtime_start = startDate ? startDate.toISOString().split('T')[0] : null;
            const units = document.getElementById(`units-${code}`).value;
    
            const apiUrl = `/update?code=${code}&realtime_end=${realtime_end}&units=${units}${realtime_start ? `&realtime_start=${realtime_start}` : ''}`;
        
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error updating graph:', data.error);
                    } else {
                        renderPlotlyGraph(data, code);
                    }
                })
                .catch(error => console.error('Error updating graph:', error));
        }
    </script>
</body>

</html>
